<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaMark | Advanced PDF Watermark Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Your existing CSS remains exactly the same */
        :root {
            --primary: #6c5ce7;
            --primary-light: #a29bfe;
            --primary-dark: #4d44db;
            --accent: #fd79a8;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --light: #f8f9fa;
            --dark: #2d3436;
            --gray: #636e72;
            --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 8px;
            --border-radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #dfe6f0 100%);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }

        .watermark-tool {
            width: 100%;
            max-width: 1000px;
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transform: translateY(0);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tool-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .tool-header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            font-weight: 700;
        }

        .tool-header p {
            font-size: 0.95rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            font-weight: 300;
        }

        .tool-content {
            padding: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 768px) {
            .tool-content {
                grid-template-columns: 1fr;
            }
        }

        .upload-section {
            grid-column: 1;
        }

        .settings-section {
            grid-column: 2;
        }

        @media (max-width: 768px) {
            .upload-section, .settings-section {
                grid-column: 1;
            }
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            font-size: 1rem;
        }

        .upload-area {
            border: 2px dashed var(--primary-light);
            border-radius: var(--border-radius);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
            position: relative;
            background: rgba(162, 155, 254, 0.05);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area.highlight {
            border-color: var(--primary);
            background: rgba(162, 155, 254, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .upload-area i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .upload-area h3 {
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .upload-area p {
            color: var(--gray);
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .upload-area .browse-text {
            color: var(--primary);
            font-weight: 500;
            text-decoration: underline;
        }

        #file-input {
            display: none;
        }

        .file-info {
            display: none;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(108, 92, 231, 0.05);
            border-radius: var(--border-radius);
        }

        .file-icon {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .file-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
            color: var(--danger);
        }

        .file-action-btn:hover {
            opacity: 0.8;
        }

        .preview-container {
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            background: var(--white);
            display: none;
        }

        .preview-title {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-content {
            width: 100%;
            height: 200px;
            background: #f9f9f9;
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .watermark-preview {
            position: absolute;
            opacity: 0.5;
            pointer-events: none;
            transform-origin: center;
            color: var(--primary);
            font-size: 40px;
            font-weight: bold;
        }

        .settings-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1em;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-input {
            width: 50px;
            height: 30px;
            padding: 2px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        .color-picker-input::-webkit-color-swatch {
            border-radius: 3px;
            border: none;
        }

        .range-slider {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-slider input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            appearance: none;
        }

        .range-slider input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .range-slider-value {
            width: 40px;
            text-align: center;
            font-size: 0.9rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: 400;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-block {
            width: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(108, 92, 231, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #00a884 100%);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
            position: relative;
            overflow: hidden;
            border: none;
        }

        .btn-success:hover::before {
            animation: shine 1.5s infinite;
        }

        @keyframes shine {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #00a884 0%, var(--success) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(108, 92, 231, 0.2);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 10px;
            margin: 12px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 6px;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .output-section {
            display: none;
            margin-top: 20px;
            animation: fadeIn 0.5s ease-out;
            grid-column: 1 / -1;
        }

        .download-container {
            text-align: center;
            padding: 18px;
            background: rgba(0, 184, 148, 0.05);
            border-radius: var(--border-radius);
            border: 1px dashed var(--success);
        }

        .download-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
        }

        .download-subtitle {
            color: var(--gray);
            margin-bottom: 16px;
            font-size: 0.85rem;
        }

        .error-message {
            color: var(--danger);
            background: rgba(214, 48, 49, 0.1);
            padding: 10px 12px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            display: none;
            animation: fadeIn 0.3s ease-out;
            font-size: 0.85rem;
            grid-column: 1 / -1;
        }

        .upload-status {
            display: none;
            text-align: center;
            margin: 10px 0;
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 500;
            grid-column: 1 / -1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .watermark-tool {
                max-width: 95%;
            }
            
            .tool-header {
                padding: 20px 15px;
            }
            
            .tool-header h1 {
                font-size: 1.8rem;
            }
            
            .tool-header p {
                font-size: 0.9rem;
            }
            
            .tool-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .tool-header h1 {
                font-size: 1.6rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .settings-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="watermark-tool">
        <div class="tool-header">
            <h1>AquaMark</h1>
            <p>Add professional watermarks to your PDF documents with customizable text, images, and styling options</p>
        </div>
        
        <div class="tool-content">
            <div class="error-message" id="error-message"></div>
            <div class="upload-status" id="upload-status"></div>
            
            <!-- Upload Section -->
            <div class="upload-section">
                <h2 class="section-title"><i class="fas fa-file-upload"></i> Upload PDF</h2>
                
                <div class="upload-area" id="upload-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Select PDF File</h3>
                    <p>Drag & drop your PDF here or <span class="browse-text">browse</span></p>
                    <input type="file" id="file-input" accept=".pdf">
                </div>
                
                <div class="file-info" id="file-info">
                    <i class="fas fa-file-pdf file-icon"></i>
                    <div class="file-details">
                        <div class="file-name" id="file-name"></div>
                        <div class="file-size" id="file-size"></div>
                    </div>
                    <button class="file-action-btn" id="remove-file-btn" title="Remove PDF">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                
                <div class="preview-container" id="preview-container">
                    <div class="preview-title">
                        <span>Watermark Preview</span>
                        <button id="refresh-preview-btn" class="file-action-btn" title="Refresh Preview">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="preview-content" id="preview-content">
                        <img id="preview-image" src="" alt="PDF Preview">
                        <div class="watermark-preview" id="watermark-preview"></div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div class="settings-section">
                <h2 class="section-title"><i class="fas fa-sliders-h"></i> Watermark Settings</h2>
                
                <div class="settings-card">
                    <div class="form-group">
                        <label for="watermark-type">Watermark Type</label>
                        <select id="watermark-type" class="form-control form-select">
                            <option value="text">Text Watermark</option>
                            <option value="image">Image Watermark</option>
                        </select>
                    </div>
                    
                    <!-- Text Watermark Settings -->
                    <div id="text-watermark-settings">
                        <div class="form-group">
                            <label for="watermark-text">Watermark Text</label>
                            <input type="text" id="watermark-text" class="form-control" value="CONFIDENTIAL">
                        </div>
                        
                        <div class="form-group">
                            <label for="watermark-font">Font</label>
                            <select id="watermark-font" class="form-control form-select">
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times-Roman">Times New Roman</option>
                                <option value="Courier">Courier</option>
                                <option value="Arial" selected>Arial</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Georgia">Georgia</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="watermark-color">Text Color</label>
                            <div class="color-picker">
                                <input type="color" id="watermark-color" class="color-picker-input" value="#808080">
                                <input type="text" id="watermark-color-hex" class="form-control" value="#808080">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="watermark-size">Text Size</label>
                            <div class="range-slider">
                                <input type="range" id="watermark-size" min="10" max="120" value="48">
                                <span class="range-slider-value" id="watermark-size-value">48</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Watermark Settings -->
                    <div id="image-watermark-settings" style="display: none;">
                        <div class="form-group">
                            <label for="watermark-image">Upload Image</label>
                            <input type="file" id="watermark-image" class="form-control" accept="image/*">
                        </div>
                        
                        <div class="form-group">
                            <label for="image-opacity">Image Opacity</label>
                            <div class="range-slider">
                                <input type="range" id="image-opacity" min="10" max="100" value="50">
                                <span class="range-slider-value" id="image-opacity-value">50%</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="image-size">Image Size</label>
                            <div class="range-slider">
                                <input type="range" id="image-size" min="10" max="200" value="50">
                                <span class="range-slider-value" id="image-size-value">50%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-card">
                    <div class="form-group">
                        <label for="watermark-position">Position</label>
                        <select id="watermark-position" class="form-control form-select">
                            <option value="center">Center</option>
                            <option value="top-left">Top Left</option>
                            <option value="top-right">Top Right</option>
                            <option value="bottom-left">Bottom Left</option>
                            <option value="bottom-right">Bottom Right</option>
                            <option value="tiled">Tiled (Repeat)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="watermark-opacity">Opacity</label>
                        <div class="range-slider">
                            <input type="range" id="watermark-opacity" min="10" max="100" value="50">
                            <span class="range-slider-value" id="watermark-opacity-value">50%</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="watermark-angle">Rotation Angle</label>
                        <div class="range-slider">
                            <input type="range" id="watermark-angle" min="0" max="360" value="45">
                            <span class="range-slider-value" id="watermark-angle-value">45°</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="watermark-all-pages" checked>
                            <label for="watermark-all-pages">Apply to all pages</label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="page-range-group" style="display: none;">
                        <label for="watermark-page-range">Page Range (e.g., 1-3,5,7-9)</label>
                        <input type="text" id="watermark-page-range" class="form-control" placeholder="All pages">
                    </div>
                </div>
                
                <div class="settings-card">
                    <div class="form-group">
                        <label for="output-filename">Output Filename</label>
                        <input type="text" id="output-filename" class="form-control" value="watermarked.pdf" placeholder="Enter filename">
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="apply-watermark-btn" disabled>
                        <i class="fas fa-stamp"></i> Apply Watermark
                    </button>
                </div>
            </div>
            
            <!-- Output Section -->
            <div class="output-section" id="output-section">
                <div class="download-container">
                    <h3 class="download-title">Your watermarked PDF is ready!</h3>
                    <p class="download-subtitle">Click below to download your document</p>
                    <a href="#" class="btn btn-success" id="download-btn">
                        <i class="fas fa-download"></i> Download PDF
                    </a>
                </div>
            </div>
            
            <!-- Progress and Loading -->
            <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Applying watermark to your PDF...</p>
            </div>
        </div>
    </div>

    <!-- PDF-Lib for client-side PDF manipulation -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- Download.js for handling file downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <!-- PDF.js for rendering PDF previews -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    
    <script>
        // Set PDF.js worker path
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const removeFileBtn = document.getElementById('remove-file-btn');
            const previewContainer = document.getElementById('preview-container');
            const previewContent = document.getElementById('preview-content');
            const previewImage = document.getElementById('preview-image');
            const watermarkPreview = document.getElementById('watermark-preview');
            const refreshPreviewBtn = document.getElementById('refresh-preview-btn');
            const applyWatermarkBtn = document.getElementById('apply-watermark-btn');
            const downloadBtn = document.getElementById('download-btn');
            const errorMessage = document.getElementById('error-message');
            const uploadStatus = document.getElementById('upload-status');
            const loading = document.getElementById('loading');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const outputSection = document.getElementById('output-section');
            const outputFilename = document.getElementById('output-filename');
            
            // Watermark Settings Elements
            const watermarkType = document.getElementById('watermark-type');
            const textWatermarkSettings = document.getElementById('text-watermark-settings');
            const imageWatermarkSettings = document.getElementById('image-watermark-settings');
            const watermarkText = document.getElementById('watermark-text');
            const watermarkFont = document.getElementById('watermark-font');
            const watermarkColor = document.getElementById('watermark-color');
            const watermarkColorHex = document.getElementById('watermark-color-hex');
            const watermarkSize = document.getElementById('watermark-size');
            const watermarkSizeValue = document.getElementById('watermark-size-value');
            const watermarkImage = document.getElementById('watermark-image');
            const imageOpacity = document.getElementById('image-opacity');
            const imageOpacityValue = document.getElementById('image-opacity-value');
            const imageSize = document.getElementById('image-size');
            const imageSizeValue = document.getElementById('image-size-value');
            const watermarkPosition = document.getElementById('watermark-position');
            const watermarkOpacity = document.getElementById('watermark-opacity');
            const watermarkOpacityValue = document.getElementById('watermark-opacity-value');
            const watermarkAngle = document.getElementById('watermark-angle');
            const watermarkAngleValue = document.getElementById('watermark-angle-value');
            const watermarkAllPages = document.getElementById('watermark-all-pages');
            const pageRangeGroup = document.getElementById('page-range-group');
            const watermarkPageRange = document.getElementById('watermark-page-range');
            
            // State
            let pdfFile = null;
            let pdfDoc = null;
            let watermarkImageFile = null;
            let previewPageNum = 1;
            let watermarkedPdfBytes = null;
            
            // Initialize event listeners
            function initEventListeners() {
                // Handle drag and drop events
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('highlight');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('highlight');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('highlight');
                    
                    const droppedFiles = e.dataTransfer.files;
                    if (droppedFiles.length > 0 && droppedFiles[0].type === 'application/pdf') {
                        handleFile(droppedFiles[0]);
                    } else {
                        showError('Please only upload PDF files.');
                    }
                });
                
                // Handle click to select file
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0 && fileInput.files[0].type === 'application/pdf') {
                        handleFile(fileInput.files[0]);
                    } else {
                        showError('Please select a PDF file.');
                    }
                });
                
                // Remove file
                removeFileBtn.addEventListener('click', () => {
                    resetTool();
                });
                
                // Watermark type toggle
                watermarkType.addEventListener('change', () => {
                    if (watermarkType.value === 'text') {
                        textWatermarkSettings.style.display = 'block';
                        imageWatermarkSettings.style.display = 'none';
                    } else {
                        textWatermarkSettings.style.display = 'none';
                        imageWatermarkSettings.style.display = 'block';
                    }
                    updateWatermarkPreview();
                });
                
                // Text watermark settings
                watermarkText.addEventListener('input', updateWatermarkPreview);
                watermarkFont.addEventListener('change', updateWatermarkPreview);
                watermarkColor.addEventListener('input', function() {
                    watermarkColorHex.value = this.value;
                    updateWatermarkPreview();
                });
                watermarkColorHex.addEventListener('input', function() {
                    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                        watermarkColor.value = this.value;
                        updateWatermarkPreview();
                    }
                });
                watermarkSize.addEventListener('input', function() {
                    watermarkSizeValue.textContent = this.value;
                    updateWatermarkPreview();
                });
                
                // Image watermark settings
                watermarkImage.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        watermarkImageFile = this.files[0];
                        updateWatermarkPreview();
                    }
                });
                imageOpacity.addEventListener('input', function() {
                    imageOpacityValue.textContent = this.value + '%';
                    updateWatermarkPreview();
                });
                imageSize.addEventListener('input', function() {
                    imageSizeValue.textContent = this.value + '%';
                    updateWatermarkPreview();
                });
                
                // Watermark appearance settings
                watermarkPosition.addEventListener('change', updateWatermarkPreview);
                watermarkOpacity.addEventListener('input', function() {
                    watermarkOpacityValue.textContent = this.value + '%';
                    updateWatermarkPreview();
                });
                watermarkAngle.addEventListener('input', function() {
                    watermarkAngleValue.textContent = this.value + '°';
                    updateWatermarkPreview();
                });
                
                // Page range toggle
                watermarkAllPages.addEventListener('change', function() {
                    pageRangeGroup.style.display = this.checked ? 'none' : 'block';
                });
                
                // Refresh preview
                refreshPreviewBtn.addEventListener('click', updateWatermarkPreview);
                
                // Apply watermark
                applyWatermarkBtn.addEventListener('click', applyWatermark);
                
                // Download button
                downloadBtn.addEventListener('click', function(e) {
                    if (!watermarkedPdfBytes) {
                        e.preventDefault();
                        return;
                    }
                    const filename = outputFilename.value.endsWith('.pdf') ? 
                        outputFilename.value : 
                        `${outputFilename.value}.pdf`;
                    download(watermarkedPdfBytes, filename, 'application/pdf');
                });
            }
            
            // Handle file selection
            async function handleFile(file) {
                try {
                    showUploadStatus('Loading PDF file...');
                    hideError();
                    
                    pdfFile = file;
                    
                    // Display file info
                    fileInfo.style.display = 'flex';
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    uploadArea.style.display = 'none';
                    
                    // Load PDF document
                    const arrayBuffer = await file.arrayBuffer();
                    pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    // Show preview and enable apply button
                    previewContainer.style.display = 'block';
                    applyWatermarkBtn.disabled = false;
                    
                    // Load first page for preview
                    await loadPreviewPage(1);
                    
                    // Update watermark preview
                    updateWatermarkPreview();
                    
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    showError('Failed to load PDF. Please ensure it\'s a valid PDF file.');
                    resetTool();
                } finally {
                    hideUploadStatus();
                }
            }
            
            // Load a specific page for preview
            async function loadPreviewPage(pageNum) {
                if (!pdfDoc) return;
                
                try {
                    // Validate page number
                    if (pageNum < 1) pageNum = 1;
                    if (pageNum > pdfDoc.numPages) pageNum = pdfDoc.numPages;
                    previewPageNum = pageNum;
                    
                    const page = await pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 0.5 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    previewImage.src = canvas.toDataURL();
                    previewImage.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error rendering preview page:', error);
                    previewImage.src = '';
                    previewImage.style.display = 'none';
                    previewContent.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray);">Could not load page preview</div>';
                }
            }
            
            // Update watermark preview
            function updateWatermarkPreview() {
                if (!pdfDoc) return;
                
                // Clear existing preview
                watermarkPreview.innerHTML = '';
                watermarkPreview.style.display = 'none';
                
                if (watermarkType.value === 'text') {
                    // Text watermark preview
                    watermarkPreview.textContent = watermarkText.value;
                    watermarkPreview.style.fontFamily = watermarkFont.value;
                    watermarkPreview.style.color = watermarkColor.value;
                    watermarkPreview.style.fontSize = watermarkSize.value + 'px';
                    watermarkPreview.style.opacity = watermarkOpacity.value / 100;
                    watermarkPreview.style.transform = `rotate(${watermarkAngle.value}deg)`;
                    watermarkPreview.style.display = 'block';
                    
                    // Position the text watermark
                    positionWatermarkPreview();
                    
                } else if (watermarkType.value === 'image' && watermarkImageFile) {
                    // Image watermark preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            // Create a canvas to handle the image with opacity
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Set canvas size to the image size
                            canvas.width = img.width * (imageSize.value / 100);
                            canvas.height = img.height * (imageSize.value / 100);
                            
                            // Apply opacity
                            ctx.globalAlpha = imageOpacity.value / 100;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // Create a new image with the canvas content
                            const watermarkedImg = new Image();
                            watermarkedImg.src = canvas.toDataURL();
                            watermarkedImg.style.transform = `rotate(${watermarkAngle.value}deg)`;
                            watermarkedImg.style.opacity = watermarkOpacity.value / 100;
                            
                            // Replace the preview content
                            watermarkPreview.innerHTML = '';
                            watermarkPreview.appendChild(watermarkedImg);
                            watermarkPreview.style.display = 'block';
                            
                            // Position the image watermark
                            positionWatermarkPreview();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(watermarkImageFile);
                }
            }
            
            // Position the watermark preview based on selected position
            function positionWatermarkPreview() {
                const previewRect = previewContent.getBoundingClientRect();
                const watermarkRect = watermarkPreview.getBoundingClientRect();
                
                switch(watermarkPosition.value) {
                    case 'center':
                        watermarkPreview.style.left = '50%';
                        watermarkPreview.style.top = '50%';
                        watermarkPreview.style.transform += ' translate(-50%, -50%)';
                        break;
                    case 'top-left':
                        watermarkPreview.style.left = '20px';
                        watermarkPreview.style.top = '20px';
                        break;
                    case 'top-right':
                        watermarkPreview.style.right = '20px';
                        watermarkPreview.style.top = '20px';
                        break;
                    case 'bottom-left':
                        watermarkPreview.style.left = '20px';
                        watermarkPreview.style.bottom = '20px';
                        break;
                    case 'bottom-right':
                        watermarkPreview.style.right = '20px';
                        watermarkPreview.style.bottom = '20px';
                        break;
                    case 'tiled':
                        // For tiled preview, we'll just show one in the center
                        watermarkPreview.style.left = '50%';
                        watermarkPreview.style.top = '50%';
                        watermarkPreview.style.transform += ' translate(-50%, -50%)';
                        break;
                }
            }
            
            // Apply watermark to PDF
            async function applyWatermark() {
                if (!pdfDoc || !pdfFile) return;
                
                try {
                    loading.style.display = 'block';
                    progressContainer.style.display = 'block';
                    applyWatermarkBtn.disabled = true;
                    hideError();
                    outputSection.style.display = 'none';
                    
                    const { PDFDocument, rgb } = PDFLib;
                    const existingPdfBytes = await pdfFile.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(existingPdfBytes);
                    
                    // Get page range to watermark
                    const pageRange = getPageRange();
                    
                    // Process each page
                    progressBar.style.width = '0%';
                    const pageCount = pageRange.length;
                    
                    for (let i = 0; i < pageCount; i++) {
                        const pageNum = pageRange[i];
                        const page = pdfDoc.getPage(pageNum - 1); // PDFLib uses 0-based index
                        
                        // Apply watermark based on type
                        if (watermarkType.value === 'text') {
                            await applyTextWatermark(pdfDoc, page);
                        } else if (watermarkType.value === 'image' && watermarkImageFile) {
                            await applyImageWatermark(pdfDoc, page);
                        }
                        
                        // Update progress
                        const progress = Math.round(((i + 1) / pageCount) * 100);
                        progressBar.style.width = `${progress}%`;
                    }
                    
                    progressBar.style.width = '100%';
                    
                    // Save the watermarked PDF
                    watermarkedPdfBytes = await pdfDoc.save();
                    
                    // Create download link
                    const filename = outputFilename.value.endsWith('.pdf') ? 
                        outputFilename.value : 
                        `${outputFilename.value}.pdf`;
                    
                    // Show output section
                    outputSection.style.display = 'block';
                    setTimeout(() => {
                        outputSection.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    
                } catch (error) {
                    console.error('Error applying watermark:', error);
                    showError('An error occurred while applying the watermark. Please try again.');
                } finally {
                    loading.style.display = 'none';
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    applyWatermarkBtn.disabled = false;
                }
            }
            
            // Apply text watermark to a page
            async function applyTextWatermark(pdfDoc, page) {
                const { width, height } = page.getSize();
                const text = watermarkText.value;
                const fontSize = parseInt(watermarkSize.value);
                const opacity = parseInt(watermarkOpacity.value) / 100;
                
                // Parse color (remove # if present and convert to RGB)
                let color = watermarkColor.value;
                if (color.startsWith('#')) color = color.substring(1);
                const r = parseInt(color.substring(0, 2), 16) / 255;
                const g = parseInt(color.substring(2, 4), 16) / 255;
                const b = parseInt(color.substring(4, 6), 16) / 255;
                
                // Calculate text width (approximate)
                const textWidth = text.length * (fontSize * 0.6);
                const textHeight = fontSize * 1.2;
                
                // Get position based on settings
                const position = getWatermarkPosition(width, height, textWidth, textHeight);
                
                page.drawText(text, {
                    x: position.x,
                    y: position.y,
                    size: fontSize,
                    color: rgb(r, g, b),
                    opacity: opacity,
                    rotate: { type: 'degrees', angle: parseInt(watermarkAngle.value) },
                    font: await pdfDoc.embedFont(watermarkFont.value === 'Arial' ? 'Helvetica' : watermarkFont.value)
                });
                
                // For tiled watermarks, add additional copies
                if (watermarkPosition.value === 'tiled') {
                    const cols = Math.ceil(width / (textWidth * 1.2));
                    const rows = Math.ceil(height / (textHeight * 1.2));
                    const xStep = width / (cols + 1);
                    const yStep = height / (rows + 1);
                    
                    for (let row = 1; row <= rows; row++) {
                        for (let col = 1; col <= cols; col++) {
                            page.drawText(text, {
                                x: xStep * col - (textWidth / 2),
                                y: yStep * row - (textHeight / 2),
                                size: fontSize,
                                color: rgb(r, g, b),
                                opacity: opacity * 0.7, // Slightly more transparent for tiled
                                rotate: { type: 'degrees', angle: parseInt(watermarkAngle.value) },
                                font: await pdfDoc.embedFont(watermarkFont.value === 'Arial' ? 'Helvetica' : watermarkFont.value)
                            });
                        }
                    }
                }
            }
            
            // Apply image watermark to a page
            async function applyImageWatermark(pdfDoc, page) {
                const { width, height } = page.getSize();
                const opacity = (parseInt(imageOpacity.value) / 100) * (parseInt(watermarkOpacity.value) / 100);
                const sizePercent = parseInt(imageSize.value) / 100;
                
                // Embed the image
                const imageBytes = await watermarkImageFile.arrayBuffer();
                let image;
                
                if (watermarkImageFile.type === 'image/png') {
                    image = await pdfDoc.embedPng(imageBytes);
                } else {
                    image = await pdfDoc.embedJpg(imageBytes);
                }
                
                const imgDims = image.scale(sizePercent);
                
                // Position and draw the image
                const position = getWatermarkPosition(width, height, imgDims.width, imgDims.height);
                
                page.drawImage(image, {
                    x: position.x,
                    y: position.y,
                    width: imgDims.width,
                    height: imgDims.height,
                    opacity: opacity,
                    rotate: { type: 'degrees', angle: parseInt(watermarkAngle.value) }
                });
                
                // For tiled watermarks, add additional copies
                if (watermarkPosition.value === 'tiled') {
                    const cols = Math.ceil(width / imgDims.width);
                    const rows = Math.ceil(height / imgDims.height);
                    const xStep = width / (cols + 1);
                    const yStep = height / (rows + 1);
                    
                    for (let row = 1; row <= rows; row++) {
                        for (let col = 1; col <= cols; col++) {
                            page.drawImage(image, {
                                x: xStep * col - (imgDims.width / 2),
                                y: yStep * row - (imgDims.height / 2),
                                width: imgDims.width,
                                height: imgDims.height,
                                opacity: opacity * 0.7, // Slightly more transparent for tiled
                                rotate: { type: 'degrees', angle: parseInt(watermarkAngle.value) }
                            });
                        }
                    }
                }
            }
            
            // Get watermark position based on selection
            function getWatermarkPosition(pageWidth, pageHeight, watermarkWidth, watermarkHeight) {
                switch(watermarkPosition.value) {
                    case 'center':
                        return {
                            x: (pageWidth - watermarkWidth) / 2,
                            y: (pageHeight - watermarkHeight) / 2
                        };
                    case 'top-left':
                        return {
                            x: 20,
                            y: pageHeight - watermarkHeight - 20
                        };
                    case 'top-right':
                        return {
                            x: pageWidth - watermarkWidth - 20,
                            y: pageHeight - watermarkHeight - 20
                        };
                    case 'bottom-left':
                        return {
                            x: 20,
                            y: 20
                        };
                    case 'bottom-right':
                        return {
                            x: pageWidth - watermarkWidth - 20,
                            y: 20
                        };
                    default: // center as fallback
                        return {
                            x: (pageWidth - watermarkWidth) / 2,
                            y: (pageHeight - watermarkHeight) / 2
                        };
                }
            }
            
            // Parse page range input into array of page numbers
            function getPageRange() {
                if (watermarkAllPages.checked) {
                    return Array.from({ length: pdfDoc.numPages }, (_, i) => i + 1);
                }
                
                const rangeStr = watermarkPageRange.value.trim();
                if (!rangeStr) return Array.from({ length: pdfDoc.numPages }, (_, i) => i + 1);
                
                const pages = new Set();
                const parts = rangeStr.split(',');
                
                for (const part of parts) {
                    if (part.includes('-')) {
                        const [start, end] = part.split('-').map(Number);
                        const realStart = Math.max(1, Math.min(start, end));
                        const realEnd = Math.min(pdfDoc.numPages, Math.max(start, end));
                        
                        for (let i = realStart; i <= realEnd; i++) {
                            pages.add(i);
                        }
                    } else {
                        const num = parseInt(part);
                        if (!isNaN(num) && num >= 1 && num <= pdfDoc.numPages) {
                            pages.add(num);
                        }
                    }
                }
                
                return Array.from(pages).sort((a, b) => a - b);
            }
            
            // Reset the tool to initial state
            function resetTool() {
                pdfFile = null;
                pdfDoc = null;
                watermarkImageFile = null;
                watermarkedPdfBytes = null;
                
                fileInfo.style.display = 'none';
                uploadArea.style.display = 'flex';
                previewContainer.style.display = 'none';
                outputSection.style.display = 'none';
                fileInput.value = '';
                watermarkImage.value = '';
                
                hideError();
            }
            
            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Show upload status
            function showUploadStatus(message) {
                uploadStatus.textContent = message;
                uploadStatus.style.display = 'block';
            }
            
            // Hide upload status
            function hideUploadStatus() {
                uploadStatus.style.display = 'none';
            }
            
            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            // Hide error message
            function hideError() {
                errorMessage.style.display = 'none';
            }
            
            // Initialize the tool
            initEventListeners();
            
            // Set up range slider value displays
            watermarkSize.addEventListener('input', () => {
                watermarkSizeValue.textContent = watermarkSize.value;
            });
            
            imageOpacity.addEventListener('input', () => {
                imageOpacityValue.textContent = imageOpacity.value + '%';
            });
            
            imageSize.addEventListener('input', () => {
                imageSizeValue.textContent = imageSize.value + '%';
            });
            
            watermarkOpacity.addEventListener('input', () => {
                watermarkOpacityValue.textContent = watermarkOpacity.value + '%';
            });
            
            watermarkAngle.addEventListener('input', () => {
                watermarkAngleValue.textContent = watermarkAngle.value + '°';
            });
        });
    </script>
</body>
</html>
